name: CI/CD for API Platform

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Create Env file
        run: |
          envsubst < ./api/.env.ci > ./api/.env
          envsubst < ./api/.env.ci > ./front/.env

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: 18

      - name: Install Frontend dependencies
        working-directory: front/
        run: |
          npm install

      - name: Build Frontend
        working-directory: front/
        run: |
          npm run build

      - name: Build Backend
        run: |
          docker-compose build

      - name: Start Backend
        run: |
          docker-compose up -d

      - name: Push to Docker Hub
        uses: docker/build-push-action@v2
        with:
          context: api
          push: true
          tags: thepiotrow/api-platform-backend:latest

      # - name: Deploy to OVH VPS
      #   uses: ovh/actions/server-deploy@main
      #   with:
      #     access_key: ${{ secrets.OVH_ACCESS_KEY }}
      #     secret_key: ${{ secrets.OVH_SECRET_KEY }}
      #     endpoint: ovh-eu
      #     server_name: my-vps
      #     command: |
      #       scp api/docker-compose.yml my-vps:/root/api-platform
      #       ssh my-vps "cd ~/api-platform && docker-compose up -d"
